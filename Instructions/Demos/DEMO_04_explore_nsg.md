<!---
---
Demo: Title: 'Azure 网络安全组 (NSG)' Learning Path/Module/Unit: '学习路径：描述 Microsoft 安全解决方案的功能；模块 1：描述 Azure 中的基本安全功能；第 6 单元：描述 Azure 网络安全组'
---
--->

# 演示：Azure 网络安全组 (NSG)

此演示与下列 Learn 内容保持一致：

- 学习路径：描述 Microsoft 安全解决方案的功能
- 模块：描述 Azure 中的基本安全功能
- 单元：描述 Azure 网络安全组

## 演示方案

在本演示中，你将探索 Azure 中网络安全组的功能，并将 NSG 应用于预创建的虚拟机。 首先简要显示由授权实验室主机托管服务提供商 (ALH) 预先创建的 VM 的相关信息。 然后，使用作为演示前设置一部分的 NSG，演示 NSG 的基本参数以及默认的入站和出站规则。 您将为 NSG 分配一个虚拟机接口，创建一个新的 RDP 规则以允许连接到虚拟机，最后对其进行测试。

### 演示第 1 部分

在这一部分，您将查看与虚拟机相关的一些参数，虚拟机是作为设置演示 (DEMO_00_pre_demo_setup.md) 的一部分创建的。

1. 打开 Microsoft Edge。  在地址栏中，输入 **https://portal.azure.com** ，然后使用授权实验室托管者 (ALH) 提供的 Azure 凭据登录。  这会带你转到 Azure 服务主页。

1. 在页面顶部的蓝色搜索框中输入“**虚拟机**”，然后从搜索结果中选择“**虚拟机**”。

1. 在“虚拟机”页中选择列出的 VM“SC900-WinVM”****。  该虚拟机应已作为演示前设置的一部分创建。  如果没有列出，请立即创建。

1. 现在位于“SC900-WinVM”页面。  注意虚拟机的一些基本信息。

1. 从左侧导航面板中，选择“网络”****。  
    1. 默认视图适用于入站端口规则。  请注意，此 VM 的网络接口未配置网络安全组。  如果选择“出站端口规则”，也同样如此。
    1. 选择“网络接口”旁边的“有效安全规则”****。  请注意，它显示“没有网络安全组或应用程序安全组与网络接口相关联”。

1. 请演示者注意，如果尝试在连接页面上检查端口状态，会得到无法验证的消息。  这并不一定意味着端口没有暴露。  您会注意到，当您使用已分配的 NSG 执行相同操作时，会得到无法访问的信息，表明该端口上的流量已被阻止。


1. 请将此浏览器选项卡保持打开状态。

### 演示第 2 部分

在本部分中，您将为 NSG 分配一个接口，并使用默认的入站和出站规则说明这些规则是如何工作的。  作为演示前设置的一部分，虚拟机应将虚拟机的网络接口分配给该 NSG，并为 RDP 流量创建新的入站规则。

1. 在 Azure 门户（portal.azure.com）上打开一个新的浏览器选项卡，在页面顶部的蓝色搜索栏中输入**网络安全组群**。 在结果中，选择“网络安全组”（请勿选择经典网络安全组）****。

1. 选择在演示前设置中创建的 NSG。 如果之前没有创建，请现在创建。 选择**创建网络安全组**并指定以下设置：
    1. 订阅：保留默认值（这是授权实验室主机托管服务提供商提供的 Azure 订阅）
    1. 资源组：**LabsSC900**（与虚拟机使用的资源组相同）。
    1. 名称：**NSG-SC900**
    1. 区域：保留默认值。
    1. 依次选择“**查看 + 创建**”、“**创建**”。
    1. 部署完成后（此过程非常快），请选择“**转到资源**”。

1. 在页面顶部显示“概要”的位置下方，你将看到有关创建的 NSG 的一些基本信息。  需要注意的两点是，没有自定义安全规则，也没有与此 NSG 关联的子网和网络接口。  尽管没有自定义安全规则，但每个 NSG 都包含默认的入站和出站规则，如页面上所示。  查看入站和出站规则。 默认入站规则拒绝所有不来自虚拟网络或 Azure 负载均衡器的入站流量。  出站规则拒绝除虚拟网络之间的流量和发到 Internet 的出站流量之外的所有出站流量。

1. 在“NSG-SC900”页面的左侧导航窗格中，选择“设置”下的“网络接口”****。
    1. 选择“**关联**”。
    1. 在选择网络接口关联的字段中，依次选择下拉箭头、“sc900-winvmXXX”，然后在窗口底部选择“确定”************。 一旦接口与 NSG 关联，它就会显示在列表中。

1. 选择虚拟机的浏览器选项卡，返回虚拟机。  您应该看到，现在有一个 NSG 连接到了虚拟机接口。  入站端口规则表将显示出来。 默认入站规则拒绝所有不来自虚拟网络或 Azure 负载均衡器的入站流量。  要测试这一点，您需要检查 RDP 端口 3389 的状态。
    1. 从页面顶部选择**连接**，然后选择**检查 3389 端口（RDP）的访问**，你会看到无法访问。  
    1. 虽然您只是针对 RDP 端口 3389 进行测试，但所有非来自其他虚拟网络或负载均衡器的入站网络流量都会被阻止。  

1. 现在，您将创建一条允许 RDP 端口入站流量的规则。  从左侧导航窗格中选择**网络**。 将显示入站端口规则表（入站端口规则选项卡有下划线）。  从页面右侧选择**添加入站端口规则**。 需要注意的一点是，不能删除默认规则，但可以通过创建优先级更高的规则来覆盖默认规则。 在“添加入站安全规则”窗口上，指定以下设置：
    1. 来源：**任何**
    1. 源端口范围：**\***
    1. 目的地：**任何**
    1. 服务：**RDP**
    1. 操作：**允许**
    1. 优先级：1000；备注：带有更小数字的规则具有更高的优先级，会先进行处理****。
    1. 名称：保留默认名称或创建自己的描述性名称。
    1. 请注意页面底部的警告标志。  我们仅将 RDP 用于测试目的和演示 NSG 的功能。
    1. 选择“**添加**”

1. 预配规则后，它将显示在入站规则列表中（可能需要刷新屏幕）。

### 演示第 3 部分

将 NSG 与虚拟机关联并创建 RDP 规则后，您将通过测试 RDP 与虚拟机的连接来显示 NSG 的影响。

1. 在浏览器上打开 SC900-WinVM - Microsoft Azure 标签。 

1. 从左侧导航面板选择**连接**。
    1. 您可以直接选择**检查访问**。  状态应显示为可访问。 或者，如果您有时间，也可以通过在 Windows 上打开远程桌面连接实例来连接虚拟机。  此选项将在成功连接后打开虚拟机。  具体步骤如下：
        1. 在 Windows 搜索栏中输入**远程桌面连接**，然后选择**打开**。
        1. 在**计算机**旁边的字段中，输入虚拟机的公共 IP 地址。
        1. 输入 IP 地址后，用户名应出现在输入 IP 地址的字段下方。 如果没有，则展开**显示选项**，输入虚拟机的用户名，然后选择**连接**。
        1. 这时会打开一个远程桌面连接窗口，显示无法验证远程计算机的身份。 您还想连接吗？ 选择**是**。
        1. 现在已连接到 VM。 向学员强调：在本例中，你能够连接到 VM，因为创建的入站流量规则允许入站流量通过 RDP 流入 VM。
        1. 通过在显示 VM IP 地址的蓝色选项卡中选择下划线“_”，以最小化 VM****。 这样就会返回“SC900-WinVM | 连接”页。

1. 从左侧导航面板选择**网络**，然后从主窗口选择**出站端口规则**。  选择默认出站规则。 默认规则允许从任何虚拟网络到任何其他虚拟网络的出站 VNet 流量，并允许出站互联网流量。 任何其他类型的出站流量都会被拒绝。  您无法删除默认规则，但可以通过创建具有更高优先级的规则来覆盖它，方法与创建入站规则相同。

1. 如果您的计时器允许，并且您希望显示出站流量的类似步骤，请执行下面列出的可选演示部分。  否则，请退出虚拟机，但保持浏览器上的 Azure 标签打开，以便进行下一步演示。

### （可选）演示第 4 部分

在这部分中，您将显示当前 NSG 的出站规则允许从虚拟机向外传输互联网流量。  然后创建一条规则来阻止来自虚拟机的出站互联网流量，最后通过尝试从虚拟机访问互联网来展示新创建规则的影响。

1. 打开在上一步中最小化的虚拟机。 这里将显示默认出站规则之一启用的互联网出站连接。 虚拟机打开并以用户身份登录后，选择 **Microsoft Edge** 打开浏览器。  由于这是你第一次打开 Microsoft Edge，可能会出现一个弹出窗口，请依次选择“**不使用你的数据开始**”、“**不使用此数据继续**”以及“**确认并开始浏览**”。
    1. 在浏览器地址栏中输入 www.bing.com，并确认你是否能够连接到搜索引擎****。
    1. 确认可以访问 www.bing.com 后，请关闭 VM 中的浏览器窗口，但让 VM 保持运行状态。

1. 通过在显示 VM IP 地址的蓝色选项卡中选择下划线“_”，以最小化 VM****。 这样就会返回“SC900-WinVM | 连接”页。  

1. 从左侧导航面板中，选择“网络”****。

1. 选择“**出站端口规则**”选项卡。你将看到默认出站规则。  注意默认规则AllowInternetOutBound。 该规则允许所有出站互联网流量。 您无法删除默认规则，但可以通过创建优先级更高的规则来覆盖它。 从页面右侧选择**添加出站端口规则**。

1. 在添加出站安全规则页面上，指定以下设置：
    1. 来源：**任何**
    1. 源端口范围：\*****
    1. 目的地：**服务标记**
    1. 目的地服务标记：**互联网**
    1. 服务：**自定义**（保留默认值）
    1. 目标端口范围：*（确保在目标端口范围字段中加一个星号）
    1. 协议：**任何**
    1. 操作：**Deny**
    1. 优先级：1000****
    1. 名称：保留默认名称或创建自己的描述性名称。
    1. 选择“**添加**”

1. 规则配置完成后，将出现在出站规则列表中。  虽然它出现在列表中，但需要几分钟时间才能生效（等待几分钟后再继续下一步）。  

1. 返回到 VM（VM 的图标应显示在页面底部的任务栏上）。

1. 在 VM 中打开 Microsoft Edge 浏览器并输入 www.bing.com****。 页面应该不会显示。  备注：如果你能够连接到 Internet，并已验证正确设置了出站规则的所有参数，则很可能是因为规则需要几分钟才能生效。  关闭浏览器，等待几分钟后再试一次。  注意：实验室环境中的 Azure 订阅可能会出现比正常情况更高的延迟。

1. 选择页面顶部中间显示 IP 地址的 **X**，关闭远程桌面连接。  此时会出现一个弹出窗口，显示“将断开远程会话连接”。 选择“**确定**”。

1. 保持浏览器上的 Azure 标签打开，以便进行下一个 Azure 演示。

### 审阅

在本演示中，你展示了 NSG 相关信息和设置（包括将接口关联到 NSG 的过程）、默认入站和出站规则，最后演示了创建新规则的步骤。
