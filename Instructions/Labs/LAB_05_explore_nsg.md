<!---
---
Lab: Title: '探索 Azure 网络安全组 (NSG)' Learning Path/Module/Unit: '学习路径：描述 Microsoft 安全解决方案的功能；模块 1：描述 Azure 中的基本安全功能；第 6 单元：描述 Azure 网络安全组'
---
--->

# 实验室：探索 Azure 网络安全组 (NSG)

此实验室与下列 Learn 内容保持一致：

- 学习路径：描述 Microsoft 安全解决方案的功能
- 模块：描述 Azure 中的基本安全功能
- 单元：描述 Azure 网络安全组

## 实验室方案

在本实验室中，你将探索 Azure 中网络安全组的功能。  探索方法是创建一个网络安全组 (NSG)，并将 NSG 分配到预先存在的虚拟机 (VM) 的接口。  配置后，观察默认入站和出站规则，创建新规则，并测试这些规则。  本实验室已为你创建用于 NSG 的 VM，因此请先查看与该 VM 关联的一些信息。
  
预计用时：30-45 分钟

### 任务 1

在此任务中，你将查看与为此实验室创建的 VM 关联的一些参数。

1. 打开 Microsoft Edge。  在地址栏中输入 https://portal.azure.com 。

1. 使用管理员凭据登录。
    1. 在“登录”窗口中，输入实验室托管提供商提供的用户名，然后选择“下一步”。
    1. 输入管理员密码，该密码应由实验室托管提供商提供。 选择“登录”。
    1. 如果系统提示保持登录状态，请选择“是”。

1. 在页面顶部显示 Azure 服务的位置下方，选择“虚拟机”。  如果未列出，则在页面顶部显示 Microsoft Azure 旁边蓝色栏的搜索框中，输入“虚拟机”，然后在搜索结果中选择“虚拟机” 。

1. 在“虚拟机”页中选择列出的 VM“SC900-WinVM”。

1. 现在位于“SC900-WinVM”页面。  请注意有关 VM 的一些基本信息。

1. 从页面顶部，选择“连接”。  选择“检查访问权限”选项，该选项在 IP 地址下列出。  此检查将使用端口 3389（用于 RDP 连接的端口）完成。  应会看到消息“无法验证”。  在本机 RDP 框中，单击“选择”。  在打开的窗口中，在“1 配置本机 RDP 的先决条件”下，应会看到“Azure 需要配置某些功能才能连接到 VM”。  在下一个任务中，你将设置 NSG 以显式允许 RDP 连接。


1. 从左侧导航面板中，选择“网络”。  
    1. 默认视图适用于入站端口规则。  请注意，此 VM 的网络接口未配置网络安全组。  如果选择“出站端口规则”，也同样如此。
    1. 选择显示“网络接口”旁边的“有效安全规则”。  请注意，它显示“没有网络安全组或应用程序安全组与网络接口相关联”。

1. 请将此浏览器标签页保持打开状态。


### 任务 2

在此任务中，你将创建网络安全组，将 VM 的网络接口分配给该 NSG，并为 RDP 流量创建新的入站规则。

1. 从打开的“NSG”选项卡中，右键单击页面顶部的“主页”链接，然后选择“在新选项卡中打开链接”，打开 Azure 服务的另一个页面 。

1. 在页面顶部的蓝色搜索栏中，输入“网络安全组”，然后从结果中选择“网络安全组” 。 切勿选择“网络安全组(经典)”。

1. 在“网络安全组”页面顶部，选择“+ 创建”。

1. 在“创建网络安全组”页面的“基本”选项卡上，指定以下设置：
    1. 订阅：保留默认值（这是授权实验室主机托管服务提供商提供的 Azure 订阅）
    1. 资源组：LabsSC900
    1. 名称：NSG-SC900
    1. 区域：保留默认值。
    1. 选择“查看 + 创建”，然后选择“创建” 。

1. 部署完成后，选择“转到资源”。

1. 在页面顶部显示“概要”的位置下方，你将看到有关创建的 NSG 的一些基本信息。  需要注意的两点是，没有自定义安全规则，也没有与此 NSG 关联的子网和网络接口。  尽管没有自定义安全规则，但每个 NSG 都包含默认的入站和出站规则，如页面上所示。  查看入站和出站规则。 默认入站规则拒绝所有不来自虚拟网络或 Azure 负载均衡器的入站流量。  出站规则拒绝除虚拟网络之间的流量和到 Internet 的出站流量之外的所有出站流量。

1. 在“NSG-SC900”页面的左侧导航窗格中，选择“设置”下的“网络接口”。
    1. 选择“关联”。
    2. 在网络接口关联的字段中，依次选择向下箭头、“sc900-winvmXXX”，然后在窗口底部选择“确定”  。 将接口关联到 NSG 后，它会显示在列表中。

1. 从左侧导航窗格中，选择“入站安全策略”。

1. 默认入站规则拒绝所有不来自虚拟网络或 Azure 负载均衡器的入站流量，因此需要设置规则以允许入站 RDP 流量（端口 3389 上的流量）。 回想一下，你不能删除默认规则，但可通过创建优先级更高的规则来替代默认规则。

1. 在页面顶部选择“添加”。 在“添加入站安全规则”窗口上，指定以下设置：
    1. 源：任何
    1. 源端口范围： **\***
    1. 目标：任何
    1. 服务：RDP
    1. 操作：**Allow**
    1. 优先级：1000。 带有更小数字的规则具有更高的优先级，会先进行处理。
    1. 名称：保留默认名称或创建自己的描述性名称。
    1. 请注意页面底部的警告标志。  我们仅将 RDP 用于测试目的和演示 NSG 的功能。
    1. 选择“添加”

1. 预配规则后，它将显示在入站规则列表中（可能需要刷新屏幕）。

1. 请将此浏览器标签页保持打开状态。  

### 任务 3

在此任务中，你将测试新创建的入站 NSG 规则，以确认是否能与 VM 建立远程桌面 (RDP) 连接。  进入 VM 后，你将检查从 VM 到 Internet 的出站连接。

1. 在浏览器中打开“SC900-WinVM - Microsoft Azure”选项卡。 如果以前关闭了浏览器选项卡，请打开新的浏览器选项卡，输入 https://portal.azure.com ，选择“虚拟机”，然后选择 VM“SC900-WinVM”  。

1. 从左侧导航面板中选择“连接”。

1. 选择“检查访问权限”（验证端口是否设置为 3389）。  状态应显示为“可访问”。

1. 现在，通过在“本机 RDP”框中单击“选择”，直接连接到 VM。
   
    1. 在打开的“本机 RDP”窗口中，选择“下载 RDP 文件”。
    1. 如果出现下载警告，请选择“保留”，然后在出现的弹出窗口中，选择“打开文件” 。
    1. 此时会打开“远程桌面连接”窗口，选择“连接”。
    1. 系统将提示输入凭据。  输入 VM 的“用户名”和“密码”（请参阅实验室说明面板上的“资源”选项卡）。
    1. 此时会打开一个“远程桌面连接”窗口，显示“无法验证远程计算机的身份。是否仍要连接?”  选择“是”  。

1. 现在已连接到 VM。 在本例中，你能够连接到 VM，因为创建的入站流量规则允许入站流量通过 RDP 流入 VM。  几秒钟后，在“欢迎”屏幕上，可看到用于选择设备隐私设置的窗口，请选择“接受”。  如果出现“网络”窗口，请选择“否”。

1. 在 RDP 会话中启动并运行 VM 后，测试从 VM 到 Internet 的出站连接。
    1. 从打开的 VM 中选择“Microsoft Edge”以打开浏览器。  由于这是你第一次打开 Microsoft Edge，可能会出现一个弹出窗口，请依次选择“不使用你的数据开始”、“不使用此数据继续”以及“确认并开始浏览”  。
    1. 在浏览器地址栏中输入 www.bing.com，并确认你是否能够连接到搜索引擎。
    1. 确认可以访问 www.bing.com 后，请关闭 VM 中的浏览器窗口，但让 VM 保持运行状态。

1. 通过在显示 VM IP 地址的蓝色选项卡中选择下划线“_”，最小化 VM。 这样就会返回“SC900-WinVM \| 连接”页。

1. 使浏览器选项卡保持打开状态，下一个任务会用到它。

### 任务 4

在上一个任务中，你已确认可以建立与 VM 的 RDP 连接。 你还在进入 VM 后确认了自己可以建立到 Internet 的出站连接。  出站 Internet 流量是受允许的，因为 NSG 的默认出站规则允许出站 Internet 流量。  在此任务中，你将完成创建自定义出站规则以阻止出站 Internet 流量并测试该规则的过程。

1. 你应该位于“SC900-WinVM \| 连接”页。 从左侧导航面板中，选择“网络”。 如果之前关闭了浏览器选项卡，请选择页面顶部的蓝色搜索栏并选择“虚拟机”，然后依次选择 VM“SC900-WinVM”和“网络” 。

1. 选择“出站端口规则”选项卡。你将看到默认出站规则。  记下默认规则“AllowInternetOutBound”。 此规则允许所有出站 Internet 流量。 不能删除默认规则，但可通过创建优先级更高的规则来替代默认规则。 在页面右侧，选择“添加出站端口规则”。

1. 在“添加出站安全规则”页面上，指定以下设置：
    1. 源：任何
    1. 源端口范围：\*
    1. 目标：**服务标记**
    1. 目标服务标记：**Internet**
    1. 服务：自定义（保留默认值）
    1. 目标端口范围：\*（确保在目标端口范围字段中加一个星号）
    1. 协议:任何
    1. 操作：Deny
    1. 优先级：1000
    1. 名称：保留默认名称或创建自己的描述性名称。
    1. 选择“添加”

1. 预配规则后，它将显示在出站规则列表中。  虽然它显示在列表中，但需要几分钟时间才会生效（请等待几分钟，然后再继续执行后续步骤）。  


1. 返回到 VM（VM 的 RDP 图标应显示在页面底部的任务栏上）。

1. 在 VM 中打开 Microsoft Edge 浏览器并输入 www.bing.com。 该页面应该不会显示。 如果能够连接到 Internet，并已验证正确设置了出站规则的所有参数，则很可能是因为规则需要几分钟才能生效。  关闭浏览器，等待几分钟，然后重试。 实验室环境中的 Azure 订阅可能会出现比正常情况更高的延迟。


1. 通过选择显示 IP 地址的页面顶部中心的“X”，关闭远程桌面连接。  此时会出现一个弹出窗口，显示“将断开远程会话连接”。 选择“确定”。

1. 在窗口左上角显示“Microsoft Azure”的蓝色条下方，选择“主页”以返回到 Azure 服务主页。

1. 使浏览器中的 Azure 选项卡保持打开状态。

### 审阅

本实验室演练了以下过程：设置网络安全组 (NSG)，将该 NSG 关联到虚拟机的网络接口，并将新规则添加到 NSG 以允许入站 RDP 流量和阻止出站 Internet 流量。
